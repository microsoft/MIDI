<Page
    x:Class="Microsoft.Midi.Settings.Views.NetworkMidi2SetupPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:views="using:Microsoft.Midi.Settings.Views"
    xmlns:local="using:Microsoft.Midi.Settings.ViewModels"
    xmlns:midi2="using:Microsoft.Windows.Devices.Midi2"
    xmlns:helpers="using:Microsoft.Midi.Settings.Helpers"
    xmlns:controls="using:CommunityToolkit.WinUI.Controls"
    xmlns:midicontrols="using:Microsoft.Midi.Settings.Controls"
    xmlns:network="using:Microsoft.Windows.Devices.Midi2.Endpoints.Network"
    mc:Ignorable="d">

    <Grid>
        
        <Grid x:Name="ContentArea">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <TextBlock Grid.Row="0" 
                       Text="{x:Bind ViewModel.TransportDescription}" Margin="0,0,0,8" />

            <ScrollViewer Grid.Row="1">
                <StackPanel Margin="0,0,8,0" HorizontalAlignment="Stretch">
                    <!-- Transport information -->

                    <!--
                    <TextBlock Text="{x:Bind ViewModel.Transport.Name, Mode=OneWay}" Style="{StaticResource SmallEmphasizedPropertyValue}"/>
                    <TextBlock Text="{x:Bind ViewModel.Transport.Description, Mode=OneWay}" Style="{StaticResource SmallPlainPropertyValue}"/>
                    -->

                    
                    <!-- TODO: notification banner with CTA if there is no configured host -->
                    
                    
                    
                    <TextBlock Style="{StaticResource SettingsSectionHeaderTextBlockStyle}" 
                           Text="Available Network MIDI 2.0 Hosts"/>

                    <!-- List of discovered network MIDI 2.0 hosts -->
                    <ItemsControl ItemsSource="{x:Bind ViewModel.RemoteHostEntriesSorted}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate x:DataType="local:MidiNetworkRemoteHostEntry">
                                <controls:SettingsCard CornerRadius="{StaticResource ControlCornerRadius}" 
                                                       Margin="3">

                                    <controls:SettingsCard.HeaderIcon>
                                        <FontIcon Style="{StaticResource CommonTasksIconStyles}" Glyph="&#xEBDE;" />
                                    </controls:SettingsCard.HeaderIcon>
                                    
                                    <controls:SettingsCard.Header>
                                        <TextBlock TextWrapping="NoWrap">
                                            <Run Text="{x:Bind Name}" FontWeight="Bold" Foreground="{StaticResource AccentFillColorDefaultBrush}" />
                                            <Run Text="on" Foreground="{StaticResource AccentFillColorDisabledBrush}" />
                                            <Run Text="{x:Bind AdvertisedHost.HostName}" />
                                        </TextBlock>
                                    </controls:SettingsCard.Header>
                                    
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto" />
                                            <ColumnDefinition Width="*" />
                                        </Grid.ColumnDefinitions>

                                        <Grid Grid.Column="0">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="150" />
                                                <ColumnDefinition Width="400" />
                                            </Grid.ColumnDefinitions>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto" />
                                                <RowDefinition Height="Auto" />
                                                <RowDefinition Height="Auto" />
                                            </Grid.RowDefinitions>

                                            <TextBlock Grid.Row="0" Grid.Column="0" Text="IP Addresses" Style="{StaticResource SmallPropertyLabel}" />
                                            <TextBlock Grid.Row="0" Grid.Column="1" Text="{x:Bind StringifiedIpAddresses}" Style="{StaticResource SmallEmphasizedPropertyValue}"  IsTextSelectionEnabled="True"/>

                                            <TextBlock Grid.Row="1" Grid.Column="0" Text="Product Instance Id" Style="{StaticResource SmallPropertyLabel}" />
                                            <TextBlock Grid.Row="1" Grid.Column="1" Text="{x:Bind AdvertisedHost.ProductInstanceId}" Style="{StaticResource SmallEmphasizedPropertyValue}" IsTextSelectionEnabled="True" />
                                        </Grid>

                                        <StackPanel Orientation="Horizontal" Grid.Column="1" Width="150">
                                            <Button Content="Connect" Tag="{x:Bind AdvertisedHost.DeviceId, Mode=OneTime}"
                                                    HorizontalAlignment="Right"
                                                    Visibility="{x:Bind IsConnected, Mode=OneWay, Converter={StaticResource BooleanToInverseVisibilityConverter}}"
                                                    Command="{x:Bind ConnectCommand}"/>
                                            <Button Content="Disconnect" Tag="{x:Bind AdvertisedHost.DeviceId, Mode=OneTime}"
                                                    HorizontalAlignment="Right"
                                                    Visibility="{x:Bind IsConnected, Mode=OneWay, Converter={StaticResource BooleanToVisibilityConverter}}"
                                                    Command="{x:Bind DisconnectCommand}"/>
                                        </StackPanel>
                                    </Grid>

                                </controls:SettingsCard>
                                
                                <!-- If not connected, show button to connect. That brings up dialog with options like creating MIDI 1 ports, security, etc. -->
                                <!-- If connected, show button to disconnect -->
                                <!-- If connected, show the associated endpoint with link to drill-down -->
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <TextBlock Style="{StaticResource SettingsSectionHeaderTextBlockStyle}" 
                           Text="Manual Connections"/>

                    <controls:SettingsCard CornerRadius="{StaticResource ControlCornerRadius}"
                                           Margin="3"
                                           Header="Connect to remote Network MIDI 2.0 host via IP or host name"
                                           Description="Not all remote hosts advertise over mDNS. If you know the IP address or host name of the host you want to connect to, you can manually connect to it here. Windows will attempt to connect to it again in the future, but if the host's address changes, you will need to update it here.">

                        <Button x:Name="CreateManualConnectionButton" Content="Create Manual Connection" Click="CreateManualConnection_Click" />
                    </controls:SettingsCard>



                    <TextBlock Style="{StaticResource SettingsSectionHeaderTextBlockStyle}" 
                           Text="Configure this PC as a Host"/>

                    <controls:SettingsExpander CornerRadius="{StaticResource ControlCornerRadius}"
                                               Margin="3"
                                               Header="Hosts"
                                               IsExpanded="True"
                                               Description="For this PC to advertise itself as a Network MIDI 2.0 host on the network, it must have at least one host entry. Typically, only one host is required. However, you may create multiple hosts if you want them to have different configuration settings. Once you create a new host, it may take a minute for it to show up on the network."
                                               ItemsSource="{x:Bind ViewModel.ConfiguredHosts}">
                        
                        <Button x:Name="CreateHostButton" Content="Create New Host" Click="CreateHost_Click" />

                        <controls:SettingsExpander.ItemTemplate>
                            <DataTemplate x:DataType="local:MidiNetworkConfiguredHostWrapper">
                                <controls:SettingsCard>
                                    <controls:SettingsCard.HeaderIcon>
                                        <FontIcon Style="{StaticResource CommonTasksIconStyles}" Glyph="&#xE839;" />
                                    </controls:SettingsCard.HeaderIcon>                                    
                                    <controls:SettingsCard.Header>
                                        <StackPanel>
                                            <Grid>
                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="Auto" />
                                                    <RowDefinition Height="Auto" />
                                                    <RowDefinition Height="Auto" />
                                                    <RowDefinition Height="Auto" />
                                                    <RowDefinition Height="Auto" />
                                                </Grid.RowDefinitions>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto" />
                                                    <ColumnDefinition Width="Auto" />
                                                </Grid.ColumnDefinitions>

                                                <TextBlock Grid.Row="0" Grid.Column="0" Text="Advertised UMP Endpoint Name" Style="{StaticResource SmallPropertyLabel}" />
                                                <TextBlock Grid.Row="0" Grid.Column="1" Text="{x:Bind Host.UmpEndpointName}" Style="{StaticResource SmallEmphasizedPropertyValueNoTrim}" />

                                                <TextBlock Grid.Row="1" Grid.Column="0" Text="Product Instance Id" Style="{StaticResource SmallPropertyLabel}" />
                                                <TextBlock Grid.Row="1" Grid.Column="1" Text="{x:Bind Host.ProductInstanceId}" Style="{StaticResource SmallEmphasizedPropertyValueNoTrim}"/>

                                                <TextBlock Grid.Row="2" Grid.Column="0" Text="Service Instance Name" Style="{StaticResource SmallPropertyLabel}" />
                                                <TextBlock Grid.Row="2" Grid.Column="1" Text="{x:Bind Host.ServiceInstanceName}" Style="{StaticResource SmallEmphasizedPropertyValueNoTrim}"/>

                                                <TextBlock Grid.Row="3" Grid.Column="0" Text="Actual Port in Use" Style="{StaticResource SmallPropertyLabel}" />

                                                <TextBlock Grid.Row="3" Grid.Column="1" 
                                                           Style="{StaticResource SmallEmphasizedPropertyValueNoTrim}">
                                                <!--    <Run Text="{x:Bind Host.ActualAddress}"  />
                                                    <Run Text=":" /> -->
                                                    <Run Text="{x:Bind Host.ActualPort}"  />
                                                </TextBlock>

                                                <TextBlock Grid.Row="4" Grid.Column="0" Text="Status" Style="{StaticResource SmallPropertyLabel}" />
                                                
                                                <TextBlock Grid.Row="4" Grid.Column="1" Text="Started" 
                                                           Visibility="{x:Bind HasStarted, Mode=OneWay, Converter={StaticResource BooleanToVisibilityConverter}}" 
                                                           Style="{StaticResource SmallEmphasizedPropertyValueNoTrim}"/>
                                                <TextBlock Grid.Row="4" Grid.Column="1" Text="Stopped" 
                                                           Visibility="{x:Bind HasStarted, Mode=OneWay, Converter={StaticResource BooleanToInverseVisibilityConverter}}"
                                                           Style="{StaticResource SmallEmphasizedPropertyValueNoTrim}"/>

                                            </Grid>
                                            
                                        </StackPanel>
                                    </controls:SettingsCard.Header>

                                    <StackPanel Orientation="Horizontal"
                                                Spacing="16"
                                                VerticalAlignment="Center">

                                        <Button Content="Start Host" 
                                                Visibility="{x:Bind HasStarted, Mode=OneWay, Converter={StaticResource BooleanToInverseVisibilityConverter}}" 
                                                Command="{x:Bind StartCommand}"
                                                />
                                        <Button Content="Stop Host" Visibility="{x:Bind HasStarted, Mode=OneWay, Converter={StaticResource BooleanToVisibilityConverter}}" 
                                                Command="{x:Bind StopCommand}"
                                                />
                                        <Button Content="Delete Host" 
                                                Command="{x:Bind DeleteCommand}"
                                                />

                                    </StackPanel>

                                </controls:SettingsCard>
                            </DataTemplate>

                        </controls:SettingsExpander.ItemTemplate>
                    </controls:SettingsExpander>

                    
                    
                    
                    <!-- Advanced settings. Uncomment when implemented -->
                    <!--
                    <TextBlock Style="{StaticResource SettingsSectionHeaderTextBlockStyle}" 
                           Text="Advanced Settings"/>


                    <controls:SettingsCard CornerRadius="9"
                                           Margin="3"
                                           Header="Transport-wide settings"
                                           Description="These settings impact all Network MIDI 2.0 endpoints, and should only be changed if you need to address a specific issue on your network.">

                        <Button x:Name="AdvancedSettingsButton" Content="Advanced Settings" Click="AdvancedSettings_Click" />
                    </controls:SettingsCard>
                    -->
                </StackPanel>
            </ScrollViewer>
        </Grid>

        <!-- Advanced Settings -->

        <ContentDialog x:Name="Dialog_AdvancedSettings"
                       Title="Advanced Network MIDI 2.0 settings"
                       PrimaryButtonText="OK" 
                       IsPrimaryButtonEnabled="True"
                       CloseButtonText="Cancel">

            <ContentDialog.Resources>
                <x:Double x:Key="ContentDialogMaxWidth">800</x:Double>
                <x:Double x:Key="ContentDialogMaxHeight">800</x:Double>
            </ContentDialog.Resources>

            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <StackPanel Orientation="Vertical" Margin="5">
                    <StackPanel Margin="3,3,3,10">
                        <TextBlock Text="These settings impact all Network MIDI 2.0 endpoints on this PC. Only make changes here if you are addressing a specific issue or problem on your network."
                               TextWrapping="WrapWholeWords"/>
                        <HyperlinkButton Content="Help and Additional Information" NavigateUri="https://aka.ms/MidiSettingsHelp_Net2_AdvancedSettings" />
                    </StackPanel>

                    <TextBox Margin="3" Header="Max Forward Error Correction Command Packet Count" MaxLength="2" Text="2" />
                    <TextBox Margin="3" Header="Max Retransmit Buffer Command Packet Count" MaxLength="2" Text="50"/>
                    <TextBox Margin="3" Header="Outbound Ping Interval (milliseconds)" MaxLength="5" Text="2000"/>
                    <TextBox Margin="3" Header="Direct Connection Rescan Interval (milliseconds)" MaxLength="5" Text="20000"/>

                </StackPanel>
            </ScrollViewer>
        </ContentDialog>

        <!-- Connect via IP or host name -->

        <ContentDialog x:Name="Dialog_CreateDirectConnection"
                       Title="Manually Create Connection to Remote Host"
                       PrimaryButtonText="OK" 
                       IsPrimaryButtonEnabled="True"
                       CloseButtonText="Cancel">

            <ContentDialog.Resources>
                <x:Double x:Key="ContentDialogMaxWidth">800</x:Double>
                <x:Double x:Key="ContentDialogMaxHeight">800</x:Double>
            </ContentDialog.Resources>

            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <StackPanel Orientation="Vertical" Margin="5">
                    <StackPanel Margin="3,3,3,10">
                        <TextBlock Text="If the remote host is on your network but does not advertise over mDNS, you can manually create a direct connect to it here. Direct connections by IP address will not automatically reconnect in the future if the IP address changes."
                               TextWrapping="WrapWholeWords"/>
                        <HyperlinkButton Content="Help and Additional Information" NavigateUri="https://aka.ms/MidiSettingsHelp_Net2_CreateDirect" />
                    </StackPanel>

                    <TextBox Margin="3" Header="IP Address or Host Name"
                             Text="{x:Bind ViewModel.NewClientHostNameOrIP, Mode=TwoWay}"/>
                    
                    <TextBox Margin="3" Header="Port Number" 
                             Text="{x:Bind ViewModel.NewClientPortNumber, Mode=TwoWay}"/>

                    <TextBox Margin="3" Header="Local Endpoint Name" 
                             Text="{x:Bind ViewModel.NewClientEndpointName, Mode=TwoWay}"/>

                    <ToggleSwitch Margin="3" Header="Create MIDI 1.0 Proxy Ports" 
                                  IsOn="{x:Bind ViewModel.NewClientEnableMidi1Ports, Mode=TwoWay}"/>
                    
                    <!-- TODO: Security, name/description, etc. -->
                </StackPanel>
            </ScrollViewer>
        </ContentDialog>

        <!-- Host Setup -->
        
        <ContentDialog x:Name="Dialog_CreateHost"
                       Title="Enable this PC as a Network MIDI 2.0 Host"
                       PrimaryButtonText="OK" 
                       IsPrimaryButtonEnabled="True"
                       CloseButtonText="Cancel">

            <ContentDialog.Resources>
                <x:Double x:Key="ContentDialogMaxWidth">800</x:Double>
                <x:Double x:Key="ContentDialogMaxHeight">800</x:Double>
            </ContentDialog.Resources>

            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <StackPanel Orientation="Vertical" Margin="15">
                    <StackPanel Margin="3,3,3,10">
                        <TextBlock Text="For remote Network MIDI 2.0 client devices to connect to this PC, it must be configured with at least one Network MIDI 2.0 Host entry. Unless you want to have different configuration settings, only one host is required."
                               TextWrapping="WrapWholeWords"/>
                        <HyperlinkButton Content="Help and Additional Information" NavigateUri="https://aka.ms/MidiSettingsHelp_Net2_CreateHost" />
                    </StackPanel>

                    <!-- Basic Settings -->

                    <controls:SettingsCard Header="Endpoint Name Visible to Other Network Clients" Margin="3">
                        <TextBox Header="Name" Width="300" MaxLength="98"
                                 Text="{x:Bind ViewModel.NewHostEndpointName, Mode=TwoWay}"/>
                    </controls:SettingsCard>

                    <controls:SettingsCard Header="Create MIDI 1.0 Proxy Ports by Default" Margin="3">
                        <ToggleSwitch IsOn="{x:Bind ViewModel.NewHostEnableMidi1Ports, Mode=TwoWay}" />
                    </controls:SettingsCard>
                    
                    <!-- Advanced Settings. -->
                    
                    <controls:SettingsExpander Margin="3" >
                        <controls:SettingsExpander.Header>
                            <TextBlock Text="Advanced Settings" />
                        </controls:SettingsExpander.Header>

                        <controls:SettingsExpander.Items>

                            <controls:SettingsCard Header="Use automatic port number" >
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="100" />
                                        <ColumnDefinition Width="200" />
                                    </Grid.ColumnDefinitions>

                                    <ToggleSwitch Grid.Column="0" Margin="3"
                                                  IsOn="{x:Bind ViewModel.NewHostUseAutomaticPortNumber, Mode=TwoWay}" 
                                                  VerticalAlignment="Bottom" />
                                    <TextBox Grid.Column="1" Margin="3" Header="Port Number" 
                                             Text="{x:Bind ViewModel.NewHostPortNumber, Mode=TwoWay}"
                                             IsEnabled="{x:Bind ViewModel.NewHostUseAutomaticPortNumber, Mode=OneWay, Converter={StaticResource BoolNegationConverter}}" 
                                             VerticalAlignment="Bottom"/>
                                </Grid>
                            </controls:SettingsCard>

                            <controls:SettingsCard Header="Advertise over mDNS">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="100" />
                                        <ColumnDefinition Width="200" />
                                    </Grid.ColumnDefinitions>

                                    <ToggleSwitch Grid.Column="0" Margin="3"  
                                                  IsOn="{x:Bind ViewModel.NewHostEnableAdvertising, Mode=TwoWay}" 
                                                  VerticalAlignment="Bottom" />
                                    
                                    <TextBox Grid.Column="1" Margin="3" 
                                             Header="Service Instance Name" 
                                             Text="{x:Bind ViewModel.NewHostServiceInstanceName, Mode=TwoWay}"
                                             IsEnabled="{x:Bind ViewModel.NewHostEnableAdvertising, Mode=OneWay}" 
                                             VerticalAlignment="Bottom"/>
                                </Grid>
                            </controls:SettingsCard>

                            <controls:SettingsCard Header="MIDI 2.0 Product Instance Id">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="300" />
                                    </Grid.ColumnDefinitions>

                                    <TextBox Grid.Column="0" Margin="3" 
                                             Header="Product Instance Id"
                                             Text="{x:Bind ViewModel.NewHostProductInstanceId, Mode=TwoWay}"
                                             MaxLength="42"
                                             VerticalAlignment="Bottom"/>
                                </Grid>
                            </controls:SettingsCard>
                            
                        </controls:SettingsExpander.Items>
                    </controls:SettingsExpander>

                    <!-- Authentication. Make this visible when supported -->
                    
                    <controls:SettingsExpander Margin="3" Visibility="Collapsed">
                        <controls:SettingsExpander.Header>
                            <TextBlock Text="Authentication" />
                        </controls:SettingsExpander.Header>

                        <controls:SettingsExpander.Items>

                            <controls:SettingsCard Header="Require Authentication">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="100" />
                                        <ColumnDefinition Width="200" />
                                    </Grid.ColumnDefinitions>

                                    <ToggleSwitch Grid.Column="0" Margin="3"  IsOn="False" VerticalAlignment="Bottom" />
                                    <ComboBox Grid.Column="1" Margin="3" 
                                              Header="Authentication Method"
                                              VerticalAlignment="Bottom">
                                        <ComboBox.Items>
                                            <x:String>Basic Authentication</x:String>
                                            <x:String>User Authentication</x:String>
                                        </ComboBox.Items>
                                    </ComboBox>
                                    
                                    <!-- TODO: Additional auth controls -->
                                </Grid>
                            </controls:SettingsCard>
                            
                        </controls:SettingsExpander.Items>
                    </controls:SettingsExpander>



                </StackPanel>
            </ScrollViewer>
        </ContentDialog>

    </Grid>
</Page>
