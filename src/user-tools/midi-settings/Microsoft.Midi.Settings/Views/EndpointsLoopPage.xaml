<Page
    x:Class="Microsoft.Midi.Settings.Views.EndpointsLoopPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:views="using:Microsoft.Midi.Settings.Views"
    xmlns:local="using:Microsoft.Midi.Settings.ViewModels"
    xmlns:midi2="using:Microsoft.Windows.Devices.Midi2"
    xmlns:helpers="using:Microsoft.Midi.Settings.Helpers"
    xmlns:controls="using:CommunityToolkit.WinUI.Controls"
    xmlns:midicontrols="using:Microsoft.Midi.Settings.Controls"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    >

    <Grid x:Name="ContentArea">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <TextBlock Grid.Row="0" x:Uid="DevicesPage_Description" Margin="0,0,0,8" />

        <ScrollViewer Grid.Row="1">
            <StackPanel Margin="0,0,8,0" HorizontalAlignment="Stretch">

                <!-- Transport -->


                <!-- If this transport supports runtime creation, have create button at this level -->


                <!--<TextBlock Text="{x:Bind ViewModel.Transport.Name, Mode=OneWay}" Style="{StaticResource SmallEmphasizedPropertyValue}"/>
                <TextBlock Text="{x:Bind ViewModel.Transport.Description, Mode=OneWay}" Style="{StaticResource SmallPlainPropertyValue}"/>-->

                <StackPanel Orientation="Horizontal">
                    <Button x:Name="CreateNewLoopbackPair" 
                        Margin="5,13,13,13"
                        Content="Create New Loopback Endpoint Pair"
                        Click="CreateNewLoopbackPair_Click"/>

                    <Button x:Name="CreateDefaultLoopbackPair" 
                            Visibility="{x:Bind ViewModel.DefaultLoopbackPairExists, Mode=OneWay, Converter={StaticResource BooleanToInverseVisibilityConverter}}"
                            Margin="5,13,13,13"
                            Content="Create Default Loopback Endpoint Pair"
                            Command="{x:Bind ViewModel.CreateDefaultLoopbackPairsCommand}"/>
                </StackPanel>

                <ItemsControl ItemsSource="{x:Bind ViewModel.MidiLoopbackEndpointPairs, Mode=OneWay}">
                    <ItemsControl.ItemTemplate>
                        
                        <DataTemplate x:DataType="local:MidiLoopbackEndpointPair">
                            <controls:SettingsCard Margin="3" CornerRadius="8">
                                <controls:SettingsCard.Header>
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>

                                        <ImageIcon Grid.Column="0" 
                                               Source="{x:Bind LoopA.Image, Mode=OneWay}" 
                                               Width="60" Height="60"
                                               Margin="8"/>

                                        <StackPanel Orientation="Vertical"
                                                    VerticalAlignment="Center"
                                                    Grid.Column="1">
                                            <TextBlock Text="{x:Bind LoopA.Name}" 
                                                       Style="{StaticResource SmallEmphasizedPropertyValue}"/>
                                            <TextBlock Text="{x:Bind LoopB.Name}" 
                                                       Style="{StaticResource SmallEmphasizedPropertyValue}"/>
                                        </StackPanel>

                                    </Grid>
                                    
                                    
                                </controls:SettingsCard.Header>
                                <controls:SettingsCard.Content>
                                    <StackPanel Orientation="Horizontal"
                                                VerticalAlignment="Center">
                                        <StackPanel Orientation="Vertical"
                                                    VerticalAlignment="Center">
                                            <TextBlock Text="{x:Bind LoopA.Id}" 
                                                       Style="{StaticResource SmallPlainPropertyValue}"/>
                                            <TextBlock Text="{x:Bind LoopB.EndpointDeviceId}" 
                                                       Style="{StaticResource SmallPlainPropertyValue}"
                                                       />
                                        </StackPanel>

                                        <Button Content="Remove" 
                                                Margin="16"
                                                Command="{x:Bind RemoveCommand}"
                                                />
                                    </StackPanel>
                                </controls:SettingsCard.Content>
                               
                            </controls:SettingsCard>
                            
                        </DataTemplate>

                    </ItemsControl.ItemTemplate>
                </ItemsControl>
                
            </StackPanel>
        </ScrollViewer>


        <!-- Create Loopbacks UI -->

        <ContentDialog x:Name="Dialog_CreateLoopbackEndpoints"
                       PrimaryButtonText="OK" 
                       IsPrimaryButtonEnabled="{x:Bind ViewModel.NewLoopbackSettingsAreValid, Mode=OneWay}"
                       CloseButtonText="Cancel"
                       PrimaryButtonCommand="{x:Bind ViewModel.CreateLoopbackPairsCommand}"
                       >
            <ContentDialog.Resources>
                <x:Double x:Key="ContentDialogMaxWidth">900</x:Double>
                <x:Double x:Key="ContentDialogMaxHeight">850</x:Double>
            </ContentDialog.Resources>

            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <StackPanel Orientation="Vertical" >
                    <TextBlock Text="Create MIDI Loopback Endpoints" 
                           Style="{StaticResource DialogHeaderTextBlockStyle}"
                           Margin="13, 9, 13, 13"/>

                    <TextBlock TextWrapping="WrapWholeWords" 
                           Text="With MIDI 2.0, all endpoints are bidirectional. Therefore, to have a proper loopback, you need to have two endpoints, A and B, cross-wired to each other. Anything sent out from Loopback A will arrive at Loopback B's input, and vice-versa."
                           Style="{StaticResource DialogDescriptionTextBlockStyle}" 
                           Margin="13"/>

                    <!-- I don't know why I need to do the crazy margins here. It renders properly outside of WinUI -->
                    <Image Height="650"
                           Width="650"
                           Stretch="Uniform"
                           HorizontalAlignment="Center" 
                           VerticalAlignment="Center"
                           Margin="0,-250,0,-250">
                        <Image.Source>
                            <SvgImageSource UriSource="/Assets/Loopback-Diagram.svg"/>
                        </Image.Source>
                    </Image>


                    <TextBlock TextWrapping="WrapWholeWords" 
                           Text="Please provide a base name for the loopback endpoints. To support use with MIDI 1.0 APIs, the name length cannot exceed 27 characters. The suffixes '(A)' and '(B)' will be appended to the base name to differentiate the two endpoints."
                           Style="{StaticResource DialogDescriptionTextBlockStyle}" 
                           Margin="13"/>


                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>

                        <TextBox Grid.Column="0" 
                                 VerticalAlignment="Top"
                                 Header="Loopback Base Name" 
                                 Width="250"
                                 Text="{x:Bind ViewModel.NewLoopbackEndpointBaseName, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                 MaxLength="27"
                                 Margin="13"/>

                        <TextBox Grid.Column="1" 
                                 VerticalAlignment="Top"
                                 Header="Description (Optional)" 
                                 Text="{x:Bind ViewModel.NewLoopbackDescription, Mode=TwoWay}"
                                 Height="100"
                                 MaxLength="500"
                                 TextWrapping="Wrap"
                                 IsSpellCheckEnabled="True"
                                 Margin="13"/>
                    </Grid>

                    <TextBlock TextWrapping="WrapWholeWords" 
                           Text="All MIDI endpoints require a unique identifer. This can be any alpha-numeric text, no spaces or special characters, up to 32 characters long, that is unique within the endpoints for this transport. A default value has been created for you."
                           Style="{StaticResource DialogDescriptionTextBlockStyle}" 
                           Margin="13"/>

                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>

                        <TextBox Header="Unique Identifier" 
                                 Text="{x:Bind ViewModel.NewUniqueIdentifier, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                 MaxLength="32"
                                 Margin="13"/>

                        <!-- second column is empty -->
                    </Grid>



                    <ToggleSwitch Margin="13"
                              IsEnabled="{x:Bind ViewModel.IsConfigFileActive, Mode=OneWay}"
                              IsOn="{x:Bind ViewModel.NewLoopbackIsPersistent, Mode=TwoWay}"
                              Header="Retain this loopback pair across service restarts/reboots. If this control is disabled, please create a configuration file using the options on the home page." 
                              />


                    <TextBlock Text="{x:Bind ViewModel.ValidationErrorMessage, Mode=OneWay}"
                           Margin="13"
                           Style="{StaticResource ValidationErrorTextBlockStyle}"
                           Visibility="{x:Bind ViewModel.NewLoopbackSettingsAreValid, Mode=OneWay, Converter={StaticResource BooleanToInverseVisibilityConverter}}" />


                </StackPanel>
            </ScrollViewer>
        </ContentDialog>


    </Grid>

</Page>
